<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LMS-DAU - Database Setup</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      padding: 40px;
      max-width: 600px;
      width: 100%;
    }

    .logo {
      text-align: center;
      margin-bottom: 30px;
    }

    .logo h1 {
      color: #C8102E;
      font-size: 32px;
      margin-bottom: 10px;
    }

    .logo p {
      color: #666;
      font-size: 14px;
    }

    .status {
      background: #f5f5f5;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .status h3 {
      color: #333;
      margin-bottom: 15px;
      font-size: 18px;
    }

    .stat-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #ddd;
    }

    .stat-item:last-child {
      border-bottom: none;
    }

    .stat-label {
      color: #666;
    }

    .stat-value {
      font-weight: bold;
      color: #C8102E;
    }

    button {
      width: 100%;
      padding: 15px;
      background: #C8102E;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 15px;
    }

    button:hover:not(:disabled) {
      background: #a00d25;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(200, 16, 46, 0.3);
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    button.secondary {
      background: #2C3E50;
    }

    button.secondary:hover:not(:disabled) {
      background: #1a252f;
    }

    .message {
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: none;
    }

    .message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      display: block;
    }

    .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      display: block;
    }

    .message.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
      display: block;
    }

    .credentials {
      background: #fff9e6;
      border: 2px solid #ffd700;
      border-radius: 10px;
      padding: 20px;
      margin-top: 20px;
      display: none;
    }

    .credentials.show {
      display: block;
    }

    .credentials h4 {
      color: #C8102E;
      margin-bottom: 15px;
    }

    .credentials .cred-item {
      background: white;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 10px;
      font-family: monospace;
    }

    .credentials .cred-item strong {
      color: #C8102E;
    }

    .loader {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #C8102E;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
      display: none;
    }

    .loader.show {
      display: block;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .link {
      text-align: center;
      margin-top: 20px;
    }

    .link a {
      color: #C8102E;
      text-decoration: none;
      font-weight: bold;
    }

    .link a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">
      <h1>üéì LMS-DAU</h1>
      <p>Tr∆∞·ªùng ƒê·∫°i h·ªçc Ki·∫øn tr√∫c ƒê√† N·∫µng</p>
      <p style="font-size: 12px; margin-top: 5px;">Database Setup Tool</p>
    </div>

    <div id="message" class="message"></div>
    <div class="loader" id="loader"></div>

    <div class="status" id="status">
      <h3>üìä Tr·∫°ng th√°i Database</h3>
      <div class="stat-item">
        <span class="stat-label">üë• Ng∆∞·ªùi d√πng:</span>
        <span class="stat-value" id="userCount">-</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">üìö Kh√≥a h·ªçc:</span>
        <span class="stat-value" id="courseCount">-</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">üìù B√†i t·∫≠p:</span>
        <span class="stat-value" id="assignmentCount">-</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">üí¨ B√†i vi·∫øt:</span>
        <span class="stat-value" id="forumPostCount">-</span>
      </div>
    </div>

    <button id="seedBtn" onclick="seedDatabase()">
      üå± T·∫°o d·ªØ li·ªáu m·∫´u
    </button>

    <button class="secondary" onclick="checkStatus()">
      üîÑ Ki·ªÉm tra tr·∫°ng th√°i
    </button>

    <div class="credentials" id="credentials">
      <h4>üîë T√†i kho·∫£n ƒëƒÉng nh·∫≠p</h4>
      <div class="cred-item">
        <strong>Gi√°o vi√™n 1:</strong><br>
        Email: giaovien@dau.edu.vn<br>
        Password: 123456
      </div>
      <div class="cred-item">
        <strong>Gi√°o vi√™n 2:</strong><br>
        Email: gvbinh@dau.edu.vn<br>
        Password: 123456
      </div>
      <div class="cred-item">
        <strong>Sinh vi√™n:</strong><br>
        Email: student1@dau.edu.vn (ho·∫∑c student2, student3)<br>
        Password: 123456
      </div>
    </div>

    <!-- Test Login Section -->
    <div style="margin-top: 30px; padding: 20px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
      <h3 style="margin-top: 0;">üß™ Test Login</h3>
      <div style="display: flex; gap: 10px; margin-bottom: 10px;">
        <input type="email" id="testEmail" placeholder="Email" value="giaovien@dau.edu.vn" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        <input type="password" id="testPassword" placeholder="Password" value="123456" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        <button onclick="testLogin()" style="padding: 8px 20px; background: #ffc107; color: #000; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">Test</button>
      </div>
      <button onclick="resetPassword()" style="padding: 8px 20px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer;">Reset Password</button>
      <div id="testResult" style="margin-top: 10px; padding: 10px; background: white; border-radius: 4px; font-size: 14px; display: none;"></div>
    </div>

    <div class="link">
      <a href="/" id="loginLink">‚Üê Quay v·ªÅ trang ƒëƒÉng nh·∫≠p</a>
    </div>
  </div>

  <script>
    const API_URL = window.location.origin + '/api';

    function showMessage(text, type = 'info') {
      const messageEl = document.getElementById('message');
      messageEl.textContent = text;
      messageEl.className = `message ${type}`;
      setTimeout(() => {
        messageEl.className = 'message';
      }, 5000);
    }

    function showLoader(show) {
      document.getElementById('loader').classList.toggle('show', show);
    }

    function updateStatus(data) {
      document.getElementById('userCount').textContent = data.users || 0;
      document.getElementById('courseCount').textContent = data.courses || 0;
      document.getElementById('assignmentCount').textContent = data.assignments || 0;
      document.getElementById('forumPostCount').textContent = data.forumPosts || 0;
    }

    async function testLogin() {
      const email = document.getElementById('testEmail').value;
      const password = document.getElementById('testPassword').value;
      const resultEl = document.getElementById('testResult');

      try {
        showLoader(true);
        const response = await fetch(`${API_URL}/seed/test-login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const data = await response.json();
        resultEl.style.display = 'block';

        if (data.success) {
          const match = data.data.passwordMatch;
          resultEl.innerHTML = `
            <strong>${match ? '‚úÖ SUCCESS' : '‚ùå FAILED'}</strong><br>
            Email: ${data.data.email}<br>
            Name: ${data.data.name}<br>
            Role: ${data.data.role}<br>
            Password Match: ${match ? 'YES ‚úÖ' : 'NO ‚ùå'}<br>
            Has Password Hash: ${data.data.hasPasswordField ? 'YES' : 'NO'}<br>
            Hash Length: ${data.data.passwordHashLength}
          `;
          resultEl.style.background = match ? '#d4edda' : '#f8d7da';
          resultEl.style.color = match ? '#155724' : '#721c24';
        } else {
          resultEl.innerHTML = `<strong>‚ùå Error:</strong> ${data.message}`;
          resultEl.style.background = '#f8d7da';
          resultEl.style.color = '#721c24';
        }
      } catch (error) {
        resultEl.style.display = 'block';
        resultEl.innerHTML = `<strong>‚ùå Error:</strong> ${error.message}`;
        resultEl.style.background = '#f8d7da';
        resultEl.style.color = '#721c24';
      } finally {
        showLoader(false);
      }
    }

    async function resetPassword() {
      const email = document.getElementById('testEmail').value;
      const password = document.getElementById('testPassword').value;

      if (!confirm(`Reset password for ${email} to "${password}"?`)) return;

      try {
        showLoader(true);
        const response = await fetch(`${API_URL}/seed/reset-password`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, newPassword: password })
        });

        const data = await response.json();

        if (data.success) {
          showMessage('‚úÖ Password reset th√†nh c√¥ng!', 'success');
          setTimeout(() => testLogin(), 500);
        } else {
          showMessage('‚ùå L·ªói: ' + data.message, 'error');
        }
      } catch (error) {
        showMessage('‚ùå L·ªói: ' + error.message, 'error');
      } finally {
        showLoader(false);
      }
    }

    async function checkStatus() {
      try {
        showLoader(true);
        showMessage('ƒêang ki·ªÉm tra...', 'info');
        
        const response = await fetch(`${API_URL}/seed/status`);
        const data = await response.json();
        
        if (data.success) {
          updateStatus(data.data);
          showMessage('ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i!', 'success');
          
          if (data.data.users > 0) {
            document.getElementById('credentials').classList.add('show');
          }
        } else {
          showMessage('L·ªói: ' + data.message, 'error');
        }
      } catch (error) {
        showMessage('L·ªói k·∫øt n·ªëi: ' + error.message, 'error');
      } finally {
        showLoader(false);
      }
    }

    async function seedDatabase() {
      if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën t·∫°o d·ªØ li·ªáu m·∫´u?\n\nL∆∞u √Ω: Ch·ªâ th·ª±c hi·ªán khi database ch∆∞a c√≥ d·ªØ li·ªáu.')) {
        return;
      }

      try {
        const seedBtn = document.getElementById('seedBtn');
        seedBtn.disabled = true;
        showLoader(true);
        showMessage('ƒêang t·∫°o d·ªØ li·ªáu m·∫´u... Vui l√≤ng ƒë·ª£i...', 'info');
        
        const response = await fetch(`${API_URL}/seed/init`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          showMessage('‚úÖ T·∫°o d·ªØ li·ªáu th√†nh c√¥ng!', 'success');
          updateStatus(data.data);
          document.getElementById('credentials').classList.add('show');
          
          setTimeout(() => {
            checkStatus();
          }, 1000);
        } else {
          showMessage('‚ùå L·ªói: ' + data.message, 'error');
          seedBtn.disabled = false;
        }
      } catch (error) {
        showMessage('‚ùå L·ªói k·∫øt n·ªëi: ' + error.message, 'error');
        document.getElementById('seedBtn').disabled = false;
      } finally {
        showLoader(false);
      }
    }

    // Check status on page load
    window.addEventListener('load', checkStatus);
  </script>
</body>
</html>
